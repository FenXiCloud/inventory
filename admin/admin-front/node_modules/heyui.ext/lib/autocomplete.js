import p from"./utils/config.js";import{u as o}from"./utils.js";import T from"./plugins/dropdown.js";import N from"./mixins/locale.js";import{openBlock as u,createElementBlock as h,normalizeClass as f,createElementVNode as c,Fragment as m,renderList as b,toDisplayString as g,withModifiers as V,createCommentVNode as d,withDirectives as k,withKeys as v,vModelText as j,renderSlot as w,createTextVNode as C}from"vue";import{_ as B}from"./_plugin-vue_export-helper.js";const r="h-autocomplete",D={name:"HAutoComplete",mixins:[N],emits:["update:modelValue","change","clear","picker","remove","enter"],props:{multiple:{type:Boolean,default:!1},mustMatch:{type:Boolean,default:!0},autoSelectFirst:{type:Boolean,default:!1},type:{type:[String],default:"key"},disabled:{type:Boolean,default:!1},datas:[Array,Object],dict:String,placeholder:{type:String},modelValue:[Number,String,Array,Object],option:Object,show:String,emptyContent:{type:[String,Object]},config:String,className:String,delay:{type:Number,default:100},noBorder:{type:Boolean,default:!1},autosize:{type:Boolean,default:!1},endInput:String,showDropdownWhenNoResult:{type:Boolean,default:!0},deletable:{type:Boolean,default:!0}},data(){return{html:"autocomplete_rander_html",focusing:!1,objects:[],object:{key:null,title:this.show,value:null},nowSelected:-1,tempValue:null,searchValue:null,oldValue:this.modelValue,focusValue:null,loading:!1,content:null,loadDatas:[],isShow:!1,searchTimeout:null,el:null,lastTrigger:null}},computed:{showPlaceholder(){return this.placeholder||this.hlang("h.autoComplate.placeholder")},showEmptyContent(){return this.emptyContent||this.hlang("h.autoComplate.emptyContent")},param(){return o.extend({},p.getOption("autocomplete.default"),this.config?p.getOption(`autocomplete.configs.${this.config}`):{},this.option)},autocompleteCls(){let e=!!this.noBorder;return e||(e=this.autosize),{[`${r}`]:!0,[`${r}-input-border`]:!this.noBorder,[`${r}-multiple`]:this.multiple,[`${r}-no-autosize`]:!e,[`${r}-disabled`]:this.disabled,focusing:this.focusing}},showCls(){return{[`${r}-show`]:!0,[`${this.className}-show`]:!!this.className,focusing:this.focusing}},groupCls(){return{[`${r}-group`]:!0,[`${r}-multiple`]:this.multiple,[`${this.className}-dropdown`]:!!this.className}},results(){let e=this.datas;if(this.dict&&(e=p.getDict(this.dict)),o.isNull(e))e=this.loadDatas;else if(e=p.initOptions(e,this),this.searchValue){let i=this.searchValue.toLowerCase();e=e.filter(n=>(n.html||n[this.param.titleName]||"").toLowerCase().indexOf(i)!=-1)}if(this.objects.length>0){let i=o.getArray(this.objects,"key").filter(n=>!o.isNull(n));e=e.filter(n=>i.indexOf(n[this.param.keyName])==-1)}let t=[];for(let i of e)t.push(this.getValue(i));return t}},watch:{modelValue(){this.oldValue!=this.modelValue&&this.parse()},disabled(){this.disabled?this.dropdown.disabled():this.dropdown.enabled()},nowSelected(){this.$nextTick(()=>{if(this.content&&this.nowSelected>-1){let e=this.content.querySelector(".h-autocomplete-item-selected"),t=this.content.querySelector(".h-autocomplete-ul");e&&t&&(e.offsetTop+e.offsetHeight-this.content.scrollTop>this.content.offsetHeight?this.content.scrollTop=e.offsetTop+e.offsetHeight-this.content.offsetHeight:e.offsetTop-this.content.scrollTop<0&&(this.content.scrollTop=e.offsetTop))}})}},beforeMount(){this.parse()},beforeUnmount(){let e=this.el;e&&(e.style.display="none",this.$el.appendChild(e)),this.dropdown&&this.dropdown.destory()},mounted(){this.$nextTick(()=>{let e=this.el=this.$el.querySelector(".h-autocomplete-show");this.content=this.$el.querySelector(".h-autocomplete-group");let t=this;this.dropdown=new T(e,{trigger:"",triggerOnce:!0,content:this.content,disabled:this.disabled,equalWidth:!0,events:{show(){t.isShow=!0}}})})},methods:{parse(){if(this.tempValue=null,this.multiple){let e=[];if(o.isArray(this.modelValue)&&this.modelValue.length>0)for(let t of this.modelValue){if(this.type=="key"&&!o.isNull(t)&&(this.dict||this.datas)){let i=[...this.results,...this.objects].filter(n=>n.key==t);i.length&&(t=i[0].value)}e.push(this.getValue(t))}this.objects=e}else{let e=null;if(this.type=="key"){if(!o.isNull(this.modelValue)){if(!this.show&&(this.dict||this.datas)&&this.results){let t=this.results.filter(i=>i[this.param.keyName]==this.modelValue);t.length>0&&(e=t[0].value)}o.isNull(e)&&(e={[this.param.keyName]:this.modelValue,[this.param.titleName]:this.show})}}else this.type=="title"?o.isNull(this.modelValue)||(e={[this.param.keyName]:this.modelValue,[this.param.titleName]:this.modelValue}):e=this.modelValue;o.isNull(e)?this.object={key:null,title:null,value:null}:o.extend(this.object,this.getValue(e)),this.tempValue=this.object.title}this.oldValue=this.modelValue},dispose(){let e=null;if(this.multiple){if(e=[],o.isArray(this.objects)&&this.objects.length>0)for(let t of this.objects)e.push(this.getV(t));return e}else{if(this.mustMatch)e=this.getV(this.object);else if(!o.isBlank(this.object.key))e=this.getV(this.object);else if(!o.isBlank(this.tempValue)){let t=null;this.type=="title"?t=this.tempValue:t={[this.param.titleName]:this.tempValue},e=t,this.object.title=this.tempValue}return e}},getV(e){return this.type=="key"?e.key:this.type=="title"?e.title:e.value},getValue(e){return!o.isObject(e)&&this.type=="object"?o.getValue({[this.param.titleName]:e},this.param):o.getValue(e,this.param)},onFocus(e){this.lastTrigger=null,this.focusing=!0,this.focusValue=e.target.value,this.multiple&&(this.searchValue=null),this.search()},focusData(){this.focusValue=this.object.title,this.multiple&&(this.searchValue=null)},onPaste(){setTimeout(()=>{this.search()},0)},onBlur(e){if(this.focusing=!1,this.lastTrigger=="picker"||this.lastTrigger=="clear")return;let t=e.target.value;this.focusValue!==t&&(this.mustMatch?!this.multiple&&this.object.key!=null?(this.object={key:null,title:null,value:null},this.setvalue("blur")):this.tempValue=null:(this.multiple&&t&&this.objects.push(this.getValue(t)),this.setvalue("blur"))),this.loading=!1,this.searchTimeout&&clearTimeout(this.searchTimeout)},onKeyDown(e){(e.keyCode||e.which||e.charCode)==8&&e.target.value===""&&this.objects.length>0?this.remove(this.objects[this.objects.length-1]):this.endInput&&e.key==this.endInput&&(e.preventDefault(),this.onEnter(e))},onKeyUp(e){let t=e.keyCode||e.which||e.charCode;t==38?this.nowSelected>0&&(this.nowSelected-=1):t==40?this.nowSelected<this.results.length-1&&(this.nowSelected+=1):t==13||this.search()},onEnter(e){let t=this.tempValue=e.target.value;e.preventDefault(),this.nowSelected>=0?(this.update(this.results[this.nowSelected]),this.setvalue("enter")):(!this.mustMatch&&this.multiple&&t&&this.objects.push(this.getValue(t)),this.setvalue("enter"))},search(){let e=this.$refs.input,t=e.value;this.tempValue=t||null,t!=this.object.title&&this.object.title&&(this.object.key=null,this.object.title=null,this.object.value=null),this.loading=!1,this.searchTimeout&&clearTimeout(this.searchTimeout),t.length>=this.param.minWord?(this.searchTimeout=setTimeout(()=>{this.updateDropdown(),o.isFunction(this.param.loadData)?(this.loading=!0,this.param.loadData.call(this.param,t,i=>{e.value===t&&(this.loading=!1,this.loadDatas=i,this.updateDropdown(),this.nowSelected=this.autoSelectFirst?0:-1)},()=>{this.loading=!1})):this.nowSelected=this.autoSelectFirst?0:-1},this.delay),this.searchValue=t,this.dropdown.update()):this.dropdown.hide()},updateDropdown(){this.$nextTick(()=>{this.dropdown&&(this.results.length==0&&!this.showDropdownWhenNoResult?this.dropdown.hide():(this.dropdown.show(),this.dropdown.update()))})},update(e){this.multiple?this.objects.push(o.copy(e)):e==null?this.object={key:null,title:null,value:null}:this.object=o.copy(e),this.tempValue=null},remove(e){this.objects.splice(this.objects.indexOf(e),1),this.setvalue("remove")},picker(e){this.update(e),this.setvalue("picker")},setvalue(e){if(this.disabled)return;this.lastTrigger=e,this.nowSelected=-1;let t=this.oldValue=this.dispose();this.focusValue=null,this.focusData(),this.multiple?this.tempValue=null:this.tempValue=this.object.title,this.$emit("update:modelValue",t,e),this.$emit("change",o.copy(this.multiple?this.objects:this.object),e);let i=document.createEvent("CustomEvent");i.initCustomEvent("setvalue",!0,!0,t),this.$el.dispatchEvent(i),e&&this.$emit(e,t),this.dropdown.hide(),setTimeout(()=>{this.searchValue=null},100)},hide(){this.loading=!1,this.dropdown.hide()},clear(){this.tempValue=null,this.focusValue=null,this.object={key:null,title:null,value:null},this.setvalue("clear")}}},x=["onClick"],E=["disabled","placeholder"],K={key:0,class:"h-icon-loading"},F=["disabled","placeholder"],M={key:0,class:"h-icon-loading"},O={key:0,class:"h-autocomplete-ul"},P=["onMousedown"],A=["innerHTML"],U={key:0,class:"h-autocomplete-empty-content"};function H(e,t,i,n,a,s){return u(),h("div",{class:f(s.autocompleteCls)},[c("div",{class:f(s.showCls)},[i.multiple?(u(),h(m,{key:0},[(u(!0),h(m,null,b(a.objects,(l,y)=>(u(),h("span",{key:y+""+l.key},[c("span",null,g(l.title),1),i.disabled?d("",!0):(u(),h("i",{key:0,class:"h-icon-close-min",onClick:V(S=>s.remove(l),["stop"])},null,8,x))]))),128)),k(c("input",{ref:"input","onUpdate:modelValue":t[0]||(t[0]=l=>a.tempValue=l),disabled:i.disabled,type:"text",class:"h-autocomplete-input h-input",placeholder:s.showPlaceholder,autocomplete:"off",onFocus:t[1]||(t[1]=(...l)=>s.onFocus&&s.onFocus(...l)),onBlur:t[2]||(t[2]=V((...l)=>s.onBlur&&s.onBlur(...l),["stop"])),onPaste:t[3]||(t[3]=(...l)=>s.onPaste&&s.onPaste(...l)),onKeyup:t[4]||(t[4]=(...l)=>s.onKeyUp&&s.onKeyUp(...l)),onKeydown:t[5]||(t[5]=(...l)=>s.onKeyDown&&s.onKeyDown(...l)),onKeypress:t[6]||(t[6]=v((...l)=>s.onEnter&&s.onEnter(...l),["enter"]))},null,40,E),[[j,a.tempValue]]),a.loading?(u(),h("i",K)):d("",!0)],64)):d("",!0),i.multiple?d("",!0):(u(),h(m,{key:1},[k(c("input",{ref:"input","onUpdate:modelValue":t[7]||(t[7]=l=>a.tempValue=l),type:"text",disabled:i.disabled,class:"h-autocomplete-input h-input",placeholder:s.showPlaceholder,autocomplete:"off",onFocus:t[8]||(t[8]=(...l)=>s.onFocus&&s.onFocus(...l)),onPaste:t[9]||(t[9]=(...l)=>s.onPaste&&s.onPaste(...l)),onBlur:t[10]||(t[10]=V((...l)=>s.onBlur&&s.onBlur(...l),["stop"])),onKeyup:t[11]||(t[11]=(...l)=>s.onKeyUp&&s.onKeyUp(...l)),onKeypress:t[12]||(t[12]=v((...l)=>s.onEnter&&s.onEnter(...l),["enter"]))},null,40,F),[[j,a.tempValue]]),a.loading?(u(),h("i",M)):a.tempValue&&(!i.disabled||i.deletable)?(u(),h("i",{key:1,class:"h-icon-close text-hover",onMousedown:t[13]||(t[13]=(...l)=>s.clear&&s.clear(...l))},null,32)):d("",!0)],64))],2),c("div",{class:f(s.groupCls)},[a.isShow?(u(),h("ul",O,[w(e.$slots,"top",{results:s.results}),(u(!0),h(m,null,b(s.results,(l,y)=>(u(),h("li",{key:l.key,class:f(["h-autocomplete-item",{"h-autocomplete-item-selected":y==a.nowSelected}]),onMousedown:S=>s.picker(l)},[l.html?(u(),h("div",{key:0,innerHTML:l.html},null,8,A)):e.$slots.item?w(e.$slots,"item",{key:2,item:l}):(u(),h(m,{key:1},[C(g(l.title),1)],64))],42,P))),128)),s.results.length==0&&i.showDropdownWhenNoResult?(u(),h("li",U,g(s.showEmptyContent),1)):d("",!0),w(e.$slots,"bottom",{results:s.results})])):d("",!0)],2)],2)}const G=B(D,[["render",H]]);export{G as A};
