import a from"./plugins/validator.js";import{u as r}from"./utils.js";import u from"./plugins/scroll-into-view.js";import d from"./plugins/message.js";import{openBlock as h,createElementBlock as n,normalizeClass as m,renderSlot as f}from"vue";import{_ as g}from"./_plugin-vue_export-helper.js";const l="h-form",c=function(e,t){let s=e;for(;s!=t;){if(r.hasClass(s,"h-form-item")&&s.getAttribute("prop"))return s;s=s.parentElement}return null},p={name:"HForm",provide:function(){return{validField:this.validField,requireds:this.requireds,removeProp:this.removeProp,setConfig:this.setConfig,updateErrorMessage:this.updateErrorMessage,updateProp:this.updateProp,labelWidth:this.labelWidth,params:this.childParams}},props:{top:{type:Number},topOffset:{type:Number,default:0},mode:{type:String,default:"single"},model:[Object,Array],labelWidth:{type:Number,default:80},rules:{type:Object,default:()=>{}},labelPosition:{type:String,default:"right"},readonly:{type:Boolean,default:!1},showErrorTip:{type:Boolean,default:!1},validOnChange:{type:Boolean,default:!0}},data(){return{modelStash:null,messages:{},dynamicRequireds:[],requireds:[],validator:null,childParams:{mode:this.mode}}},computed:{formCls(){return{[`${l}`]:!0,[`${l}-${this.mode}`]:!0,[`${l}-label-${this.labelPosition}`]:!!this.labelPosition,[`${l}-readonly`]:this.readonly}}},watch:{model(){this.modelStash=r.copy(this.model)},mode(){this.childParams.mode=this.mode},rules:{handler(){this.validator?(this.rules&&this.validator.updateRule(this.rules),this.dynamicRequireds.forEach(e=>{this.validator.setConfig(e,{required:!0})})):this.model&&this.rules&&(this.validator=new a(this.rules)),this.initRequires()},deep:!0}},beforeMount(){this.model&&this.rules&&(this.validator=new a(this.rules)),this.model&&(this.modelStash=r.copy(this.model))},unmounted(){this.validator&&this.validator.destroy()},mounted(){this.initRequires(),this.$nextTick(()=>{this.$el.addEventListener("blur",e=>{(e.target.tagName=="INPUT"||e.target.tagName=="TEXTAREA")&&this.trigger(e.target)},!0),this.$el.addEventListener("setvalue",e=>{this.trigger(e.target)})})},methods:{initRequires(){if(this.requireds.splice(0),this.rules){let e=r.toArray(this.rules.rules,"key").filter(t=>t.required===!0).map(t=>t.key);this.requireds.push(...this.rules.required||[],...e,...this.dynamicRequireds)}},resetValue(){return this.modelStash},resetValid(){for(let e in this.messages)this.messages[e].valid=!0},trigger(e){if(!this.validOnChange)return!1;let t=c(e,this.$el);t&&t.getAttribute("validable")=="true"&&this.validField(t.getAttribute("prop"))},validField(e){if(!e||!this.validator||!this.model)return{valid:!0};let t=this.validator.validField(e,this.model,{next:s=>{r.extend(!0,this.messages,s)}});return r.extend(!0,this.messages,t),r.extend({},this.messages[e])},validFieldJs(e,t){if(!e||!this.validator||!this.model)return{valid:!0};let s=this.messages[e],i=this.validator.validField(e,this.model,{next:()=>{t(r.extend({},s,i[e]))}});return r.extend({},s,i[e])},setConfig(e,t){let s=this.dynamicRequireds.indexOf(e);if(t.required?s==-1&&this.dynamicRequireds.push(e):s>-1&&this.dynamicRequireds.splice(s,1),this.initRequires(),!this.validator)return!1;this.validator.setConfig(e,t)},updateErrorMessage(e,t){let s={valid:!0,message:null,label:t};return this.messages[e]?(Object.assign(this.messages[e],s),this.messages[e]):(this.messages[e]=s,this.messages[e])},updateProp(e,t){let s=r.copy(this.messages[t]);return r.isNull(s)&&(s={valid:!0,message:null}),this.messages[e]=s,s},removeProp(e){let t=this.dynamicRequireds.indexOf(e);t>-1&&this.dynamicRequireds.splice(t,1),this.setConfig(e,{required:!1})},renderMessage(e){let t=!0;for(let i in e)if(!e[i].valid){t=!1;break}return r.extend(!0,this.messages,e),{result:t,messages:r.toArray(this.messages,"prop").filter(i=>!i.valid)}},tipError(e){if(e&&!e.result){let t=e.messages[0];this.showErrorTip&&(t.type=="base"?d.error(`${t.label}${t.message}`):d.error(`${t.message}`)),this.$nextTick(()=>{let s=this.$el.querySelector(`.h-form-item-valid-error[prop='${t.prop}']`);s&&u(s,{time:500,align:{top:this.top,topOffset:this.topOffset}})})}},validAsync(){return new Promise(e=>{let t=this.valid(s=>{let i=this.renderMessage(s);t&&t.result&&this.tipError(i),e(i)})})},valid(e){if(!this.validator||!this.model)return{result:!0,messages:[]};let t=this.validator.valid(this.model,i=>{r.extend(!0,this.messages,i)},i=>{e&&e.call(null,i)}),s=this.renderMessage(t);return this.tipError(s),s}}};function v(e,t,s,i,y,o){return h(),n("div",{class:m(o.formCls)},[f(e.$slots,"default")],2)}const P=g(p,[["render",v]]);export{P as F};
