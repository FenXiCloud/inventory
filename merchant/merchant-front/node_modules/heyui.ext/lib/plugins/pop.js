import d from"./popper.js";import{u as a}from"../utils.js";const h={container:!1,delay:0,html:!1,placement:"top",triggerOnce:!1,content:"",disabled:!1,trigger:"hover focus",offset:0,equalWidth:!1,type:"dropdown",preventOverflow:!1,getContainer:null,maxWidth:null};class u{constructor(t,e){e=a.extend({},h,e),this.reference=t,this.options=e;const o=typeof e.trigger=="string"?e.trigger.split(" ").filter(n=>["click","hover","focus","manual","contextMenu"].indexOf(n)!==-1):[];this.isOpen=!1,this.arrowSelector=e.arrowSelector,this.innerSelector=e.innerSelector,this.triggerEvents=[],e.content.nodeType===1&&(e.content.style.display="none"),this.setEventListeners(o,e)}create(t,e,o){const n=window.document.createElement("div");n.innerHTML=e;const i=n.childNodes[0],r=this.options.html;i.id=`pop_${Math.random().toString(36).substr(2,10)}`;const s=n.querySelector(this.innerSelector);if(o.nodeType===1)r&&s.appendChild(o),o.style.display="block";else if(a.isFunction(o)){const p=o.call(t);r?s.innerHTML=p:s.innerText=p}else r?s.innerHTML=o:s.innerText=o;return i}updateContent(t){if(this.options.content=t,!this.popNode||t==null)return;const e=this.popNode.querySelector(this.innerSelector),o=this.options.html;t.nodeType===1?(o&&e.replaceChild(t,e.firstChild),t.style.display="block"):o?e.innerHTML=t:e.innerText=t,this.update()}initPopNode(){let t=this.reference,e=this.options;const o=e.content||t.getAttribute("content");if(!o)return this;const n=this.create(t,e.template,o,e.html);n.setAttribute("aria-describedby",n.id),this.reference.setAttribute("aria-describe",n.id),this.findContainer().appendChild(n),e.class&&a.addClass(n,e.class),e.className&&a.addClass(n,e.className);const r=n.querySelector(this.innerSelector);r&&e.maxWidth&&(r.style.maxWidth=`${e.maxWidth}px`),this.popNode=n,this.popNode.setAttribute("aria-hidden","true"),this.options.trigger.indexOf("hover")>-1&&this.setPopNodeEvent()}initPopper(){let t=this.reference,e=this.options,o=this.popNode;const n=this.findContainer();let i={computeStyle:{gpuAcceleration:!1},arrow:{enabled:!1},inner:{enabled:!1},preventOverflow:{boundariesElement:"window",enabled:!0}};this.options.offset&&(i.offset={enabled:!0,offset:this.options.offset}),this.options.preventOverflow&&n.tagName!="BODY"&&n.tagName!="HTML"&&(i.hide={enabled:!1},i.flip={boundariesElement:n,enabled:!0},i.preventOverflow={enabled:!1}),this.options.trigger=="contextMenu"&&(i.flip={enabled:!1});let r={placement:e.placement,modifiers:i};this.popperOptions=r,this.popperInstance=new d(t,o,r)}disabled(){this.options.disabled=!0}enabled(){this.options.disabled=!1}show(t){if(this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout2&&clearTimeout(this.hideTimeout2),this.options.events&&a.isFunction(this.options.events.show)&&this.options.events.show(t),this.isOpen||this.options.disabled)return this;if(this.isOpen=!0,this.popNode||this.initPopNode(),this.popperInstance||this.initPopper(),this.popperInstance.enableEventListeners(),!!this.popNode)return this.options.equalWidth&&(this.popNode.style.width=`${this.reference.clientWidth}px`),this.popNode.style.display="",a.addClass(this.reference,"h-pop-trigger"),this.showTimeout=setTimeout(()=>{this.popNode.setAttribute("aria-hidden","false"),this.popperInstance.update()},0),this}update(){this.popperInstance&&this.popperInstance.update()}hide(){if(this.showTimeout&&clearTimeout(this.showTimeout),this.hideTimeout&&clearTimeout(this.hideTimeout),this.isOpen!==!1&&!!document.body.contains(this.popNode))return this.popNode?this.popperInstance?(this.hideTimeout=setTimeout(()=>{a.removeClass(this.reference,"h-pop-trigger"),this.options.events&&a.isFunction(this.options.events.hide)&&this.options.events.hide.call(null),this.popNode&&this.popNode.setAttribute("aria-hidden","true"),this.isOpen=!1,this.hideTimeout2=setTimeout(()=>{this.popNode&&(this.popNode.style.display="none",this.popperInstance&&this.popperInstance.disableEventListeners())},300)},this.options.delay),this):this:this}destory(){return this.documentHandler&&(document.removeEventListener("click",this.documentHandler),document.removeEventListener("contextmenu",this.documentHandler)),this.popperInstance&&this.popperInstance.destroy(),this.triggerEvents.forEach(({event:t,func:e})=>{this.reference.removeEventListener(t,e,t=="focus"||t=="blur")}),this.triggerEvents=[],this.popNode&&(this.hide(),this.popNode.parentNode.removeChild(this.popNode),this.popNode=null),this}findContainer(){let t=this.options.container;return typeof t=="string"?t=window.document.querySelector(t):this.options.getContainer?t=this.options.getContainer(this.reference):t===!1&&(t=document.body),t}setEventListeners(t){let e=this.reference;const o=[],n=[];t.forEach(i=>{switch(i){case"hover":o.push("mouseenter"),n.push("mouseleave");break;case"focus":o.push("focus"),n.push("blur");break;case"click":o.push("click"),this.options.triggerOnce||n.push("click");break;case"contextMenu":o.push("contextmenu"),n.push("click");break}}),o.forEach(i=>{const r=s=>{if(s.type=="contextmenu"){s.preventDefault(),window.getSelection?window.getSelection().removeAllRanges():document.selection.empty();let p=e.getBoundingClientRect();this.options.offset=`${s.clientX-p.x}, -${p.bottom-s.clientY-10}`,this.popperInstance&&(this.popperInstance.defaultOptions.modifiers.offset={enabled:!0,offset:this.options.offset},this.popperInstance.updateModifiers(),this.popperInstance.update())}i=="click"&&this.isOpen===!0||(s.usedByPop=!0,this.show(s))};this.triggerEvents.push({event:i,func:r}),e.addEventListener(i,r,i=="focus")}),n.forEach(i=>{const r=s=>{s.usedByPop!==!0&&this.hide()};this.triggerEvents.push({event:i,func:r}),e.addEventListener(i,r,i=="blur")}),t.indexOf("manual")==-1&&(this.documentHandler=i=>{if(!this.popNode||i.target.parentNode==null)return;if(!this.isOpen||e.contains(i.target)||this.popNode.contains(i.target))return!1;let r=i.reference;if(e&&this.popNode.contains(r))return!1;let s=i.target;for(;s&&s.tagName!="BODY"&&s.tagName!="HTML"&&!s.getAttribute("aria-describedby")&&s.parentNode;)s=s.parentNode;if(s.tagName!="BODY"&&s.tagName!="HTML"){let p=document.body.querySelector(`[aria-describe="${s.getAttribute("aria-describedby")}"]`);if(p&&this.popNode.contains(p))return!1}this.hide()},document.addEventListener("click",this.documentHandler),document.addEventListener("contextmenu",this.documentHandler))}setPopNodeEvent(){this.popNode.addEventListener("mouseenter",t=>{this.show(t)}),this.popNode.addEventListener("mouseout",t=>{const e=t.relatedreference||t.toElement||t.relatedTarget;!this.popNode.contains(e)&&e!=this.reference&&!this.reference.contains(e)&&this.hide()})}}export{u as default};
