import O from"./utils/config.js";import{u as n}from"./utils.js";import{h as C,resolveComponent as c,openBlock as o,createElementBlock as h,normalizeClass as d,withDirectives as w,createElementVNode as f,Fragment as y,renderList as j,withModifiers as D,createCommentVNode as m,createBlock as g,toDisplayString as S,createVNode as _,vShow as M}from"vue";import{C as I}from"./checkbox.js";import E from"./mixins/locale.js";import{_ as V}from"./_plugin-vue_export-helper.js";import{S as F}from"./search.js";const B=function(t){let s=t.$parent;for(;s&&s.$parent&&s.$.type.name!=="HTree";)s=s.$parent;return s||console.error("[HeyUI Error] Tree Component: Please put TreeItem component in the Tree Component"),s},A={name:"hTreeSlot",props:{data:Object},render(){let t=B(this);return t&&t.$slots&&t.$slots.item?C("div",{class:"h-tree-item-slot"},[t.$slots.item({item:this.data})]):C("span")}},L={name:"HTreeItem",components:{TreeSlot:A,Checkbox:I},emits:["trigger"],mixins:[E],props:{data:Object,param:Object,multiple:Boolean,status:Object,chooseMode:String,toggleOnSelect:Boolean,selectOnClick:Boolean,level:Number},data(){return{}},methods:{clickShow(){this.selectOnClick&&this.select()},select(){(this.toggleOnSelect||this.multiple)&&this.toggleTree(),!this.data.status.disabled&&(this.$emit("trigger",{type:"selectEvent",data:this.data}),this.multiple&&this.data.children.length==0&&this.choose())},choose(){Object.assign(this.data.status,{choose:!this.data.status.choose,indeterminate:!1}),this.$emit("trigger",{type:"chooseEvent",data:this.data})},trigger({type:t,data:s}){if(t=="chooseEvent"&&this.chooseMode!="independent"&&this.data.children){let e=!0,a=!1;for(let i of this.data.children)!i.status.choose&&e&&(e=!1),(i.status.choose||i.status.indeterminate)&&(a=!0);this.chooseMode=="all"?Object.assign(this.data.status,{choose:e,indeterminate:a&&!e}):this.chooseMode=="some"&&Object.assign(this.data.status,{choose:a,indeterminate:!1})}this.$emit("trigger",{type:t,data:s})},toggleTree(){this.data.status.isWait?this.loadData():this.$emit("trigger",{type:"toggleTreeEvent",data:this.data})},loadData(){this.$emit("trigger",{type:"loadDataEvent",data:this.data})}}},K={class:"h-tree-show-expand"},H={key:0,class:"h-icon-angle-right"},P={key:1,class:"h-icon-loading"},U=f("i",{class:"h-icon-angle-right"},null,-1),W=[U],z={key:1},q={key:2},G={key:0,class:"h-tree-ul"};function J(t,s,e,a,i,l){const u=c("Checkbox"),p=c("TreeSlot"),b=c("hTreeItem");return o(),h("li",{class:d(["h-tree-li",{"h-tree-li-opened":e.data.status.opened}])},[w(f("div",{class:d(["h-tree-show",{"h-tree-show-disabled":e.data.status.disabled,"h-tree-show-choose":e.data.status.choose,"h-tree-show-indeterminate":e.data.status.indeterminate,"h-tree-show-selected":e.status.selected==e.data.key}]),onClick:s[3]||(s[3]=(...r)=>l.clickShow&&l.clickShow(...r))},[(o(!0),h(y,null,j(e.level,r=>(o(),h("span",{key:r,class:"h-tree-show-space"}))),128)),f("span",K,[e.data.status.isWait?(o(),h("span",{key:0,onClick:s[0]||(s[0]=D(r=>l.toggleTree(),["stop"]))},[e.data.status.loading?(o(),h("i",P)):(o(),h("i",H))])):e.data.children&&e.data.children.length>0?(o(),h("span",{key:1,onClick:s[1]||(s[1]=D(r=>l.toggleTree(),["stop"]))},W)):m("",!0)]),e.multiple&&e.data.status.checkable?(o(),g(u,{key:0,modelValue:e.data.status.choose,disabled:e.data.status.disabled,indeterminate:e.data.status.indeterminate,onChange:l.choose},null,8,["modelValue","disabled","indeterminate","onChange"])):m("",!0),f("div",{class:d(["h-tree-show-desc",{selected:e.status.selected==e.data.key}]),onClick:s[2]||(s[2]=(...r)=>l.select&&l.select(...r))},[e.data.icon?(o(),h("span",{key:0,class:d(["h-tree-show-icon",e.data.icon])},null,2)):m("",!0),e.data.title!=null?(o(),h("span",z,S(e.data.title),1)):(o(),h("span",q,S(t.hlang("h.common.empty")),1))],2),_(p,{data:e.data.value},null,8,["data"])],2),[[M,!e.data.status.hide]]),e.data.children&&e.data.children.length>0?(o(),h("ul",G,[(o(!0),h(y,null,j(e.data.children,r=>(o(),g(b,{key:r.key,data:r,param:e.param,status:e.status,multiple:e.multiple,"choose-mode":e.chooseMode,"toggle-on-select":e.toggleOnSelect,"select-on-click":e.selectOnClick,level:e.level+1,onTrigger:l.trigger},null,8,["data","param","status","multiple","choose-mode","toggle-on-select","select-on-click","level","onTrigger"]))),128))])):m("",!0)],2)}const Q=V(L,[["render",J]]),k="h-tree",v=(t,s,e)=>{if(t.children)for(let a of t.children)a.status[s]=e,v(a,s,e)},T=(t,s,e,a)=>{let i=t[s.parentKey];!n.isNull(s.parentKey)&&i&&(i.status[e]=a,T(t,i,e,a))},x=t=>{if(t.children){let s=!1,e=!!t.children.length;for(let a of t.children)x(a),(a.status.choose||a.status.indeterminate)&&(s=!0),a.status.choose||(e=!1);t.status.choose||(e?t.status.choose=!0:s&&(t.status.indeterminate=!0))}},N=(t,s)=>{if(t.status.choose)s.push(t.value);else for(let e of t.children)N(e,s);return s},R={name:"HTree",components:{treeItem:Q,Search:F},props:{option:Object,multiple:{type:Boolean,default:!1},filterable:{type:Boolean,default:!1},chooseMode:{type:String,default:"all"},modelValue:[Number,String,Array,Object],config:String,toggleOnSelect:{type:Boolean,default:!0},selectOnClick:{type:Boolean,default:!1},className:{type:String,default:"h-tree-theme-item-selected"}},emits:["open","select","choose","update:modelValue","change","loadDataSuccess"],data(){return{updateFromInput:!1,globalloading:!1,loading:!0,status:{selected:null},treeDatas:[],treeObj:{},searchValue:null}},computed:{param(){return this.config?n.extend({},O.getOption("tree.default"),O.getOption(`tree.configs.${this.config}`),this.option):n.extend({},O.getOption("tree.default"),this.option)},treeCls(){return{[k]:!0,[`${k}-multiple`]:this.multiple,[`${k}-single`]:!this.multiple,[this.className]:!!this.className}}},watch:{modelValue(){if(this.updateFromInput){this.updateFromInput=!1;return}this.parse()},"option.datas":function(){this.initTreeDatas()}},mounted(){this.initTreeDatas(),this.parse()},methods:{parse(){this.multiple?this.updateChoose(this.modelValue,!1):this.updateSelect(this.modelValue,!1)},updateTreeItem(t,s){let e=this.treeObj[t];if(e)for(let a of Object.keys(s))e.value[a]=s[a],a==this.param.titleName&&(e.title=s[a]);this.$forceUpdate()},appendTreeItem(t,s){let e=this.treeObj[t],a=this.initTreeNode(s,t);e?e.children.push(a):this.treeDatas.push(a),this.treeObj[a.key]=a},removeTreeItem(t){let s=this.treeObj[t];if(s){let e=this.treeDatas.indexOf(s);if(e>-1)this.treeDatas.splice(e,1);else if(s.parentKey&&this.treeObj[s.parentKey]){let a=this.treeObj[s.parentKey];a.children.indexOf(s)>-1&&a.children.splice(a.children.indexOf(s),1)}delete this.treeObj[t]}},searchTree(t){if(this.searchValue=t,!n.isNull(this.searchValue)&&this.searchValue!==""){let s=this.searchValue.toLowerCase();for(let e of Object.keys(this.treeObj)){let a=this.treeObj[e];a.status.hide=(a.html||a.title||"").toLowerCase().indexOf(s)==-1}this.expandAll()}else for(let s of Object.keys(this.treeObj)){let e=this.treeObj[s];e.status.hide=!1}},trigger({type:t,data:s,update:e}){if(e&&Object.assign(s.status,e),t=="toggleTreeEvent")s.status.opened=!s.status.opened,this.$emit("open",s.value);else if(t=="loadDataEvent")n.isFunction(this.param.getDatas)&&(s.status.loading=!0,this.param.getDatas.call(this.param,s.value,a=>{s.children=this.initTreeModeData(a,!0),s.status.isWait=!1,s.status.loading=!1,s.status.opened=!0},()=>{s.status.loading=!1}));else if(t=="selectEvent")this.multiple||(this.status.selected=s.key,this.$emit("select",s.value),this.setvalue());else if(t=="chooseEvent"){let a=s.status.choose;this.chooseMode!="independent"&&v(s,"choose",a),this.$emit("choose",this.getChoose()),this.multiple&&this.setvalue()}},initTreeDatas(){let t=[];if(n.isArray(this.param.datas)?t=this.param.datas:n.isFunction(this.param.datas)&&(t=this.param.datas.apply(this.param)),n.isFunction(this.param.getTotalDatas)||n.isFunction(this.param.getDatas)){t=[],this.globalloading=!0;let s=this.param.getTotalDatas||this.param.getDatas,e=[a=>{this.treeDatas=this.initDatas(n.copy(a)),this.parse(),this.globalloading=!1,this.$emit("loadDataSuccess")},()=>{this.globalloading=!1}];this.param.getDatas&&e.unshift(null),s.apply(this.param,e)}this.treeDatas=this.initDatas(t),this.parse()},initDatas(t){let s=t=n.copy(t);this.param.dataMode=="list"&&t.length>0&&(s=n.generateTree(t,this.param));let e=n.isFunction(this.param.getDatas);return this.initTreeModeData(s,e)},initTreeModeData(t,s,e){let a=[];for(let i of t){let l=this.initTreeNode(i,e,s),u=i[this.param.childrenName]||[];l.children=this.initTreeModeData(u,s,l.key),this.treeObj[l.key]=l,a.push(l)}return a},initTreeNode(t,s,e=!1){return{key:t[this.param.keyName],title:t[this.param.titleName],value:t,parentKey:s,icon:t.treeIcon,status:{hide:!1,opened:!1,loading:!1,checkable:t.checkable!==!1,isWait:e,selected:!1,indeterminate:!1,choose:!1,disabled:!!t.disabled},children:[]}},refresh(){this.initTreeDatas()},expandAll(){for(let t of Object.keys(this.treeObj))this.treeObj[t].status.opened=!0},foldAll(){for(let t of Object.keys(this.treeObj))this.treeObj[t].status.opened=!1},expand(t){for(let s of Object.keys(this.treeObj)){let e=this.treeObj[s];e.status.opened=t.indexOf(e.key)>-1}},chooseAll(){for(let t in this.treeObj)this.treeObj[t].status.choose=!0;this.setvalue()},updateSelect(t,s=!0){if(t===null)this.status.selected=null;else{let e=this.treeObj[t];e&&(this.status.selected=t,T(this.treeObj,e,"opened",!0))}s&&this.setvalue()},getSelect(){return n.isNull(this.status.selected)?null:this.treeObj[this.status.selected].value},updateChoose(t,s=!0){if(!!this.multiple){t=t||[];for(let e of Object.keys(this.treeObj)){let a=this.treeObj[e];a.status.choose=!1,a.status.indeterminate=!1,a.status.opened=!1}for(let e of t){let a=this.treeObj[e];a&&(a.status.choose=t.indexOf(a.key)!=-1,a.status.choose&&(a.status.opened=!0,T(this.treeObj,a,"opened",!0),this.chooseMode=="all"&&v(a,"choose",!0)))}if(this.chooseMode=="all")for(let e of this.treeDatas)x(e);s&&this.setvalue()}},setvalue(){let t=null;if(this.multiple)t=this.getChoose().map(i=>i[this.param.keyName]);else{let e=this.getSelect();t=e?e[this.param.keyName]:null}this.updateFromInput=!0,this.$emit("update:modelValue",t),this.$emit("change",t);let s=document.createEvent("CustomEvent");s.initCustomEvent("setvalue",!0,!0,t),this.$el.dispatchEvent(s)},getFullChoose(){let t=[];for(let s of Object.keys(this.treeObj)){let e=this.treeObj[s];e.status.choose&&t.push(e.value)}return t},getChoose(){if(this.chooseMode=="some")return this.getFullChoose();if(this.chooseMode=="independent")return this.getFullChoose();{let t=[];for(let s of this.treeDatas)t=N(s,t);return t}}}},X={class:"h-tree-body"};function Y(t,s,e,a,i,l){const u=c("Search"),p=c("treeItem"),b=c("Loading");return o(),h("div",{class:d(l.treeCls)},[e.filterable?(o(),g(u,{key:0,modelValue:i.searchValue,"onUpdate:modelValue":s[0]||(s[0]=r=>i.searchValue=r),block:"",onSearch:l.searchTree},null,8,["modelValue","onSearch"])):m("",!0),f("ul",X,[(o(!0),h(y,null,j(i.treeDatas,r=>(o(),g(p,{key:r.key,data:r,param:l.param,multiple:e.multiple,status:i.status,"choose-mode":e.chooseMode,"toggle-on-select":e.toggleOnSelect,"select-on-click":e.selectOnClick,level:0,onTrigger:l.trigger},null,8,["data","param","multiple","status","choose-mode","toggle-on-select","select-on-click","onTrigger"]))),128))]),_(b,{loading:i.globalloading},null,8,["loading"])],2)}const le=V(R,[["render",Y]]);export{le as T};
